<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Supabase & Refresh Env Plesk</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .status { padding: 15px; border-radius: 8px; margin: 10px 0; }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        button { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        .env-info { background: #e9ecef; padding: 15px; border-radius: 6px; margin: 20px 0; }
    </style>
</head>
<body>
<h1>üß™ Test Supabase DB & Refresh Variabili Plesk</h1>

<div class="env-info">
    <strong>DATABASE_URL impostata:</strong> <%= dbStatus.databaseUrlSet ? '‚úÖ S√å' : '‚ùå NO' %><br>
    <small>Se NO, aggiungi DATABASE_URL nelle variabili personalizzate Plesk > Node.js > Custom Environment Variables</small>
</div>

<h2>Test Connessione DB</h2>
<% if (dbStatus.success) { %>
    <div class="status success">
        ‚úÖ <strong>CONNESSIONE OK!</strong><br>
        Tempo server: <%= dbStatus.time %><br>
        PostgreSQL: <%= dbStatus.pgVersion %><br>
        Token stats: <%= dbStatus.tokenStats %> righe
    </div>
<% } else { %>
    <div class="status error">
        ‚ùå <strong>ERRORE CONNESSIONE:</strong><br>
        <%= dbStatus.error %><br>
        <small>Verifica DATABASE_URL nelle variabili Plesk e riavvia l'app</small>
    </div>
<% } %>

<button id="refreshBtn" onclick="testDb()">üîÑ Ritest DB</button>
<button id="restartBtn" onclick="restartApp()">‚ôªÔ∏è Refresh Variabili & Restart App</button>

<script>
    async function testDb() {
        const btn = document.getElementById('refreshBtn');
        btn.disabled = true;
        btn.textContent = 'Testando...';

        try {
            const res = await fetch('/api/test-db');
            const data = await res.json();
            location.reload(); // Ricarica per aggiornare la pagina
        } catch (error) {
            alert('Errore test DB: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.textContent = 'üîÑ Ritest DB';
        }
    }

    async function restartApp() {
        if (!confirm('Riavviare l\'app Node.js?\n\nLe nuove variabili d\'ambiente verranno caricate dopo il restart.')) return;

        const btn = document.getElementById('restartBtn');
        btn.disabled = true;
        btn.textContent = 'Riavvio in corso...';

        try {
            const res = await fetch('/api/restart-app', { method: 'POST' });
            const data = await res.json();
            alert(data.message);
            setTimeout(() => location.reload(), 2000);
        } catch (error) {
            alert('Errore restart: ' + error.message);
        }
    }
</script>
</body>
</html>
